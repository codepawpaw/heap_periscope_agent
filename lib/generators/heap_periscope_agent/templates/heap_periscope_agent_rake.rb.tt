# This file was generated by `rails generate heap_periscope_agent:rake_instrumentation`
# It instruments Rake to track memory usage for the entire duration of a Rake command.

# We only want to apply this patch when running Rake tasks, not in a Rails server or console.
is_rake_execution = (defined?(Rake) && Rake.application.top_level_tasks.any?)
is_server_or_console = (defined?(Rails::Server) || defined?(Rails::Console))

if is_rake_execution && !is_server_or_console
  HeapPeriscopeAgent.log("Setting up Rake instrumentation for HeapPeriscopeAgent.")

  module HeapPeriscopeAgent
    module RakeApplicationInstrumentation
      def top_level
        begin
          HeapPeriscopeAgent.log("Rake execution started. Starting agent...")
          HeapPeriscopeAgent.start
          super
        ensure
          HeapPeriscopeAgent.log("Rake execution finished. Stopping agent.")
          HeapPeriscopeAgent.stop
        end
      end
    end
  end

  Rake::Application.prepend(HeapPeriscopeAgent::RakeApplicationInstrumentation)
  HeapPeriscopeAgent.log("Rake::Application is now instrumented by HeapPeriscopeAgent.")
end